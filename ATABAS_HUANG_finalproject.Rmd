---
title: "Final Project"
author: "Tolga Atabas and Sherry Huang"
date: "1/20/2021"
output: bookdown::html_document2
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(ggplot2)
library(ggthemes)
library(tidyverse)
library(dplyr)
library(maps)
library(plotly)
library(readr)
```

```{r plot themes}
theme_proj = theme_tufte() + 
  theme(plot.title.position = "plot")
```

```{r}
spotify <- read.csv("data.csv")
spotify_by_year <- read.csv("data_by_year.csv")
```

# Introduction

Music has an incredibly fascinating effect on people. Humans are one of the few, if not the only, animals that can naturally feel rhythms. When music is played, it only takes moments for people to clap along to the beat of the song. Specific genres and styles of music have defined generations and cultures time and time again. It’s only natural for music to be so powerful for people.

This notion has picked up much attention in the media. In fact, ABC Science released a video a few years ago ( [watch it here](https://www.youtube.com/watch?v=rnUSNbqtVJI) ). discussing the power of music on the brain, specifically for people with dementia and Parkinson’s. In the video, researchers showed how playing music reminiscent of one’s past can trigger memories, even for someone who has forgotten them. They did so by curating specially tailored playlists from the pasts of certain residents at a nursing home. When the dementia patients listened to these playlists, many of them had a sudden shift in mood. Their family members were so surprised to see them “come back to life,” in a sense. These residents would talk about their past and be more open and happy than they had been in months.

Another segment of the video showed how music can help with diseases that affect the motor system, like Parkinson’s. At a human movement lab, a professor has spent years analyzing and trying to solve these movement disorders. One thing she tried was playing music, and it’s incredible to see the change that overcomes her patients. John, one of her patients, suffers from Parkinson’s. The video shows how the debilitating disease limits his natural motor skills and prevents him from having voluntary movements. However, after applying a nice tune with the professor’s music, John is able to not only walk, but dance with a partner.

The last part of the video follows a man named Shane who suffered severe brain damage from a bike accident. Following the accident, he could barely speak, move, and recall anything. Later, he became part of an experiment to see if music could invoke memories for people who had severe memory loss from brain injuries. The results showed that he did as well as people with normal, healthy brains, despite the accident. For example, Shane had trouble recalling a memory from grade school if he was just asked to, but had no issues doing so if a song from grade school was being played.

This video illustrates not only the power in music, but its prevalence in our natural being. It is much more than a form of entertainment, it is part of a complete life. The rhythm and tunes of songs -- whether from traditional instruments, natural sounds, or digital playlists -- bury themselves in our brains and become an integral part of human life. 

Additionally, music is not immune to the various societal trends that can morph and change over time. Since it is a form of art, it generally reflects on what major feelings and emotions are being spread in a given time. The prevalence of music in our lives combined with the artistic essence makes it a strong vantage point when looking at how society changes the way it expresses itself. For example, there are times in the late 1940’s and 1950’s where songs tend to be filled with sad or melancholic lyrics, making for more of a “low-mood” song. This has much to do with the major wars at the time, namely World War II and the subsequent Cold War. 

Other trends in music, and art in general, can illuminate these trends. Seeing the trends in how artists express their views of the world provides a look into life at during a given time period. Furthermore, the advantageous point with music is also that the popularity of a song or genre can be tracked. Music therefore not only gives a perspective on what songs and emotions are being produced in a given time, but to what extent each is consumed. So, it is possible to look at both the expressed emotions in music, and how much it resonates with listeners.

Change in music is not limited to different life periods, but is also present in different phases in one’s life. For example, there is a popular practice for pregnant mothers to play classical music for their babies in hopes of making them more intelligent. In other phases of life, teens may be warned to stay away from certain genres of music because it will “rot their brains” or act as a bad influence. In either case, music enters our lives early. Many young musical prodigies are discovered because they begin reacting to music even before they are able to speak or walk.

Our plan for this study relies on a comprehensive data set supplied by the [Spotify API](https://developer.spotify.com/documentation/web-api/reference-beta/#endpoint-get-audio-features). This data encompasses many interesting variables, and there is much to experiment with. It provides a fertile ground for exploration into how music affects humans. Two variables specifically are eye-catching: valence, a measure of the happiness of a song, and explicitness, whether a song contains explicit lyrics or not. There are also variables regarding year published, popularity, acousticness, etc. There is a perceived trend that current music (2010-2020) is becoming more and more explicit and despairing. In fact, this can be seen in Figure \@ref(fig:scattervalyear) with a dip in valence after 1975. It may be possible to look at these different characteristics in acousticness, valence, and explicitness to create a model that predicts the popularity of music. 


```{r scattervalyear,fig.width=5,fig.height=3,fig.cap="Scatterplot of Spotify's valence score by year"}

ggplot(data = spotify_by_year) +
  geom_point(mapping = aes(x = year, y = valence)) +
  labs(title = "Happiness of Music Over Time",
       x = "Year",
       y = "Valence (0 to 1)",
       caption = "SOURCE: Spotify") +
  theme_proj +
  #need to add gridlines because tufte removes them
  theme(panel.grid.major = element_line(color = "gray90"),
        panel.grid.minor = element_line(color = "gray90"))
```


In addition to a study of trends in music consumption, this study aims to take a closer look at correlations between the music dataset and other datasets in mental health and crime. Is it possible that the prevalence in explicit music is rising with crime rates? Is it possible that the decrease in valence score is correlated with an increase in mental health cases? These questions will be discussed in the subsequent sections.

# Data

**Music:**
The music dataset is made available through the [Spotify API](https://developer.spotify.com/documentation/web-api/reference-beta/#endpoint-get-audio-features). Spotify is an audio streaming service that was launched in 2008 and is now one of the most popular streaming platforms for music and podcasts. Therefore, the dataset is fairly comprehensive and contains lots of  information due to Spotify’s status as one of the most popular sites for music consumption. 

The data encompasses many interesting variables. Of course there are descriptors such as artist or band name, year of song, genre, and key, but there are many other metrics that require more attention.

These specially catered metrics usually range from 0 to 1. For example Spotify describes the metric for the valence (happiness) of a song as follows: “A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry)”.

Other metrics such as explicitness are described as follows: “Whether or not the episode has explicit content (true = yes it does; false = no it does not OR unknown)”. Whereas danceability is described as: “Danceability describes how suitable a track is for dancing based on a combination of musical elements including tempo, rhythm stability, beat strength, and overall regularity. A value of 0.0 is least danceable and 1.0 is most danceable”. 

**Crime:**

The United Nations Office on Drugs and Crime (UNODC) has many comprehensive datasets that pertain to crime of all different shapes and forms. The organization, as a subset of the United Nations works to cover pressing concerns related to crime, tackling crime, and preventing crime. The datasets present on their website are grouped in a manner that makes it easy to choose what to study. For example, the differentiation is made between sexual assault, homicide, and drug crimes. Further, homicide can be analyzed more specifically through the different mechanisms (firearm, sharp object, unkown, etc.)

With a dataset of this comprehensive nature, it is possible to make different comparisons by extracting the parts of the data that are of interest. 

Some limitations to this dataset it more about the collection than anything. The data are collected from the annual United Nations crime trends survey from national authorities. This method not only relies on countries reporting to the U.N., but also relies on local authorities within countries like the U.S. and their reports to the federal level. There may be differences in reporting crime when compared to different countries, and that disparity can also exist within any given country, as well. This needs to be kept in consideration when drawing conclusions.

Since all of these datasets were provided in separate files, it was necessary to read the excel files separately and then follow with a merge by year.

The data also comes in a format that is not easy to work with, having a column of rate and count for each year (i.e. rate of crime, count of crime). The years available are from 2010 to 2017.

```{r}
library(readxl)

#2010
assault10 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2010...18","2010...19")) %>%
  pivot_longer(!c("...1","...2","...3","2010...19"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2010", times=length(.$drop)))

assault10 = assault10[,-5]

colnames(assault10) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault10 = assault10[-1,]

#2011
assault11 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2011...20","2011...21")) %>%
  pivot_longer(!c("...1","...2","...3","2011...21"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2011", times=length(.$drop)))

assault11 = assault11[,-5]

colnames(assault11) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault11 = assault11[-1,]

#2012
assault12 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2012...22","2012...23")) %>%
  pivot_longer(!c("...1","...2","...3","2012...23"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2012", times=length(.$drop)))

assault12 = assault12[,-5]

colnames(assault12) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault12 = assault12[-1,]

#2013
assault13 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2013...24","2013...25")) %>%
  pivot_longer(!c("...1","...2","...3","2013...25"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2013", times=length(.$drop)))

assault13 = assault13[,-5]

colnames(assault13) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault13 = assault13[-1,]

#2014
assault14 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2014...26","2014...27")) %>%
  pivot_longer(!c("...1","...2","...3","2014...27"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2014", times=length(.$drop)))

assault14 = assault14[,-5]

colnames(assault14) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault14 = assault14[-1,]

#2015
assault15 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2015...28","2015...29")) %>%
  pivot_longer(!c("...1","...2","...3","2015...29"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2015", times=length(.$drop)))

assault15 = assault15[,-5]

colnames(assault15) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault15 = assault15[-1,]

#2016
assault16 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2016...30","2016...31")) %>%
  pivot_longer(!c("...1","...2","...3","2016...31"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2016", times=length(.$drop)))

assault16 = assault16[,-5]

colnames(assault16) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault16 = assault16[-1,]

#2017
assault17 <- read_excel("serious_assault_0.xlsx") %>%
  select(c("...1","...2","...3","2017...32","2017...33")) %>%
  pivot_longer(!c("...1","...2","...3","2017...33"), names_to = "drop", values_to = "Count") %>%
  mutate(Year = rep("2017", times=length(.$drop)))

assault17 = assault17[,-5]

colnames(assault17) = c("Region","Subregion", "Country", "Rate", "Count", "Year") 

assault17 = assault17[-1,]

assault <- assault10 %>% bind_rows(assault11) %>% bind_rows(assault12) %>% bind_rows(assault13) %>% bind_rows(assault14) %>% bind_rows(assault15) %>% bind_rows(assault16) %>% bind_rows(assault17)

nas <- matrix(c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, sum(is.na(assault10$Rate)), sum(is.na(assault11$Rate)), sum(is.na(assault12$Rate)), sum(is.na(assault13$Rate)), sum(is.na(assault14$Rate)), sum(is.na(assault15$Rate)), sum(is.na(assault16$Rate)), sum(is.na(assault17$Rate))), ncol = 2, byrow = FALSE)

colnames(nas) = c("Year", "NAs")

rm(assault10, assault11, assault12, assault13, assault14, assault15, assault16, assault17)
```

The data from UNODC will be in regards to

+ Assault 
+ Robbery
+ Sexual Violence

**World Happiness:**

The first World Happiness Report was released on April 1, 2012 as a foundational text for the UN High Level Meeting: Well-being and Happiness: Defining a New Economic Paradigm, drawing international attention. The report outlined the state of world happiness, causes of happiness and misery, and policy implications highlighted by case studies. In 2013, the second World Happiness Report was issued, and since then has been issued on an annual basis with the exception of 2014. The report primarily uses data from the Gallup World Poll.

The rankings of national happiness are based on a Cantril ladder survey. Nationally representative samples of respondents are asked to think of a ladder, with the best possible life for them being a 10, and the worst possible life being a 0. They are then asked to rate their own current lives on that 0 to 10 scale. The report correlates the results with various life factors.

In the reports, experts in fields including economics, psychology, survey analysis, and national statistics, describe how measurements of well-being can be used effectively to assess the progress of nations, and other topics. Each report is organized by chapters that delve deeper into issues relating to happiness, including mental illness, the objective benefits of happiness, the importance of ethics, policy implications, and links with the Organization for Economic Co-operation and Development's (OECD) approach to measuring subjective well-being and other international and national efforts.

Data is collected from people in over 150 countries. Each variable measured reveals a populated-weighted average score on a scale running from 0 to 10 that is tracked over time and compared against other countries. These variables currently include:

+ real GDP per capita
+ social support
+ healthy life expectancy
+ freedom to make life choices
+ generosity
+ perceptions of corruption

Each country is also compared against a hypothetical nation called Dystopia. Dystopia represents the lowest national averages for each key variable and is, along with residual error, used as a regression benchmark. The six metrics are used to explain the estimated extent to which each of these factors contribute to increasing life satisfaction when compared to the hypothetical nation of Dystopia, but they themselves do not have an impact on the total score reported for each country

```{r reading-happiness-datasets}
# reading in world happiness datasets
happiness_2015 <- read.csv("2015.csv") %>% mutate(year = 2015)
happiness_2016 <- read.csv("2016.csv") %>% mutate(year = 2016)
happiness_2017 <- read.csv("2017.csv") %>% mutate(year = 2017)
happiness_2018 <- read.csv("2018.csv") %>% mutate(year = 2018)
happiness_2019 <- read.csv("2019.csv") %>% mutate(year = 2019)
happiness_2020 <- read.csv("2020.csv") %>% mutate(year = 2020)

# renaming like variables so we can bind the datasets
colnames(happiness_2017) = c("Country", "Happiness.Rank", "Happiness.Score",
                             "Upper.Confidence.Interval", "Lower.Confidence.Interval",
                             "Economy..GDP.per.Capita.", "Family", "Health..Life.Expectancy.",
                             "Freedom", "Generosity", "Trust..Government.Corruption.",
                             "Dystopia.Residual", "year")

colnames(happiness_2018) = c("Happiness.Rank", "Country", "Happiness.Score",
                             "Economy..GDP.per.Capita.", "Family", "Health..Life.Expectancy.",
                             "Freedom", "Generosity", "Trust..Government.Corruption.",
                             "year")

colnames(happiness_2019) = c("Happiness.Rank", "Country", "Happiness.Score",
                             "Economy..GDP.per.Capita.", "Family", "Health..Life.Expectancy.",
                             "Freedom", "Generosity", "Trust..Government.Corruption.",
                             "year")

colnames(happiness_2020) = c("Country", "Region", "Happiness.Score", "Standard.Error",
                             "Upper.Confidence.Interval", "Lower.Confidence.Interval",
                             "Logged.GDP.per.capita", "Family", "Healthy.life.expectancy",
                             "Freedom", "Generosity", "Trust..Government.Corruption.",
                             "Ladder.score.in.Dystopia", "Explained.by..Log.GDP.per.capita",
                             "Explained.by..Social.support",
                             "Explained.by..Healthy.life.expectancy",
                             "Explained.by..Freedom.to.make.life.choices",
                             "Explained.by..Generosity",
                             "Explained.by..Perceptions.of.corruption",
                             "Dystopia.Residual", "year")

# removing United Arab Emirates from happiness_2018 because it made the variable
# Trust..Government.Corruption. a chr instead of num, preventing us form binding
# it to the other world happiness datasets
happiness_2018 <- happiness_2018[-20,]
happiness_2018 <- happiness_2018 %>% mutate(Trust..Government.Corruption. =
                                              as.numeric(Trust..Government.Corruption.))

# combining all the world happiness datasets
happiness <- happiness_2015 %>% bind_rows(happiness_2016) %>% bind_rows(happiness_2017) %>%
  bind_rows(happiness_2018) %>% bind_rows(happiness_2019) %>% bind_rows(happiness_2020)
```

In the above code, I have changed the variable names in each dataset so they should all (mostly) match with each other. Then, I combined all the datasets into one big "happiness" dataset.

# Exploration

## Spotify

There are some natural thoughts that may come up when thinking about what two characteristics in music may support each other, or on the other hand, go against each other. For example, one may think that acousticness and energy of a song are not necessarily compatible traits, however danceability and loudness may hold promise in a positive correlation. The pairs plot in Figure \@ref(fig:gally) explores these relationships and correlations.

```{r gally, fig.width=8,fig.height=8,fig.cap="Pairs plot for the variables in the Spotify dataset"}
library(GGally)

spotify_by_year %>%
  select(valence, acousticness, danceability, duration_ms, energy, instrumentalness, liveness, loudness, popularity, speechiness) %>%
  GGally::ggpairs()

```

By looking at the pairs plot, it is possible to see that acousticness and energy are inversely related, and pretty strong at that (refer to plot with \@ref(fig:gally), r = -0.967***). There are many other relationships to explore later when building a model. However, another promising relationships is between the loudness and popularity parameters. The songs that are louder also have a tendancy to be more popular.

## Happiness

Before we begin combining the Spotify dataset with other datasets, it's important to look at those datasets individually. For example, how does the World Happiness dataset change over each year? The world map below, in Figure \@ref(fig:plotlyhappiness), is an interactive map that displays the change in world happiness in countries over the years from $2015$ to $2020$. (Hover over countries to see more specific information.)

```{r plotlyhappiness, fig.cap="Map of World Happiness from 2015 - 2020"}
#loading dataset of each country's ISO code (because plotly needs it to map countries)
country_code <- read_csv("wikipedia-iso-country-codes.csv")

#joining together happiness and country_code dataset
happiness_plotly <- left_join(country_code, happiness, by = c("English short name lower case" = "Country"))

#renaming the happiness dataset variables
colnames(happiness_plotly) = c("Country", "two.code", "three.code", "Numeric.code", "ISO",
                        "Region", "Happiness.Rank", "Happiness.Score", "Standard.Error",
                        "Economy..GDP.per.Capita.", "Family", "Health..Life.Expectancy.",
                        "Freedom", "Trust..Government.Corruption.", "Generosity",
                        "Dystopia.Residual", "year", "Lower.Confidence.Interval",
                        "Upper.Confidence.Interval", "Logged.GDP.per.capita",
                        "Healthy.life.expectancy", "Ladder.score.in.Dystopia",
                        "Explained.by..Log.GDP.per.capita", "Explained.by..Social.support",
                        "Explained.by..Healthy.life.expectancy",
                        "Explained.by..Freedom.to.make.life.choices",
                        "Explained.by..Generosity",
                        "Explained.by..Perceptions.of.corruption")

#"hover" variable: this specifies what info is displayed when you hover over a country
happiness_plotly <- happiness_plotly %>% mutate(hover = paste0(Country, "\nHappiness Rank: ", Happiness.Rank, "\nHappiness Score: ", Happiness.Score))

#hover label aesthetics
fontStyle <- list(family = "Arial", size = 15, color = "black")
label <- list(bgcolor = "#EEEEEE", bordercolor = "transparent", font = fontStyle)

#plotly map!
p1 <- plot_geo(happiness_plotly, locationmode = "world", frame = ~year) %>%
  add_trace(locations = ~three.code,
            z = ~Happiness.Score,
            zmin = 2,
            zmax = 8,
            color = ~Happiness.Score,
            colorscale = "Electric", #changes color of scale
            text = ~hover, #displays info in "hover" variable we made above
            hoverinfo = "text") %>% #makes hover info the text from above line
  layout(font = list(family = "Arial"), title = "World Happiness Report \n 2015 - 2020") %>%
  style(hoverlabel = label) %>%
  config(displayModeBar = FALSE) #hides the plotly toolbar in top right

p1
```

## Crime

Continuing with the exploration, it is time to look at the crime data. The crime data comes from the United Nations Office on Drugs and Crime and depends on reportings from each country. This can create a discrepancy because each country has different considerations and guidelines on crime which will dictate if a specific incident enters their records or not.

Withstanding these limitations, it is still beneficial to look at what is made available at hand. The shiny app allows the viewing of country assault rates, filtered by regions.

```{r shiny}
library(shiny)

regions = assault$Region

ui <- fluidPage(
    
    # Application title
    titlePanel("Looking at Rate by Region (make a selection)"),
    
    # Sidebar layout with a input and output definitions
    sidebarLayout(
        # Inputs: Select variables to plot
        sidebarPanel(
            
            # Select variable for location
            selectInput(inputId = "region", 
                        label = "Region:",
                        choices = regions, 
                        selected = "Americas",
                        multiple = FALSE),
            
            uiOutput("sub")
        ),
        
        #Output
        
        mainPanel(
            
            # Show plot
            plotlyOutput(outputId = "plot"),
            br(),        # a little bit of visual separation
            
        )
    )
)

# Define server function --------------------------------------------
server <- function(input, output) {
    
    output$sub <- renderUI({
        this_region <- assault %>%
            filter(Region == input$region)
        sub_this_location <- sort(unique(this_region$Subregion))
        
        selectInput(inputId = "sub", label = "Sub Region:", choices = sub_this_location, selected = "Northern America")
    })
    
    # Creates plot object the plotOutput function is expecting
    output$plot <- renderPlotly({
        
        #Creates base plot 
        
        Region_of_Interest = input$region
        Sub_of_Interest = input$sub
        
        plot_data <- assault %>% 
            filter(Region == Region_of_Interest) %>%
            filter(Subregion == Sub_of_Interest) 
            
            p3 <- ggplot(data = plot_data) + 
          geom_jitter(aes(x = Year, y = as.numeric(Rate), 
                          color = Country, text = Country), 
                      size = 3, alpha = 0.8, width = 0.3) +
          theme_proj +
          #need to add gridlines because tufte removes them
          theme(panel.grid.major = element_line(color = "gray90"),
                panel.grid.minor = element_line(color = "gray90"),
                legend.position = "none") +
          labs(x = "Year", y = "Assault rate (per 100,000 population",
               caption = "Source: UNOCD Serious Assault Data")
          
            
        
        ggplotly(p3, tooltip = "text")
    })
    
    
}

# Create the Shiny app object ---------------------------------------
shinyApp(ui, server, options = list(height = 500))
```

The shiny app makes it possible to see trends in countries of certain regions and how they compare to each other. For example, it is clear that Hungary and Czech Republic have the highest rates of assault in the Eastern European regions. This type of observation can be made with a few other countries as well. Each region has a separate country that stands out.

Even more, however, it is possible to see that there have not been many changes in rates over time. For example, the average rates as shown in \@ref(fig:bars) shows that the rates have not changed greatly over the years.

```{r}

```

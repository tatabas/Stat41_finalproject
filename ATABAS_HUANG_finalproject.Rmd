---
title: "Final Project"
author: "Tolga Atabas and Sherry Huang"
date: "1/20/2021"
output: bookdown::html_document2
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(ggplot2)
library(ggthemes)
library(tidyverse)
library(dplyr)
library(maps)
library(plotly)
library(readr)
library(patchwork)
```

```{r plot themes}
theme_proj = theme_minimal(base_family = "Palatino") + 
  theme(plot.title.position = "plot")

#plot.background = element_rect(fill = "#FEF5D1")
```

```{r loading data}
#data is cleaned in ATABAS_HUANG_dataCleaning.Rmd and loaded here
spotify <- read.csv("data/data.csv")
spotify_by_year <- read.csv("data/data_by_year.csv")
happiness_2015 <- read.csv("data/2015.csv")
happiness_2016 <- read.csv("data/2016.csv")
happiness_2017 <- read.csv("data/2017.csv")
happiness_2018 <- read.csv("data/2018.csv")
happiness_2019 <- read.csv("data/2019.csv")
happiness_2020 <- read.csv("data/2020.csv")
happiness <- read.csv("data/happiness.csv")
robbery <- read.csv("data/robbery.csv")
assault <- read.csv("data/assault.csv")
sexualviolence <- read.csv("data/sexualviolence.csv")
all_together <- read.csv("data/alltogether.csv")
```

# Introduction

[GitHub](https://github.com/tatabas/Stat41_finalproject)

Music has an incredibly fascinating effect on people. Humans are one of the few, if not the only, animals that can naturally feel rhythms. When music is played, it only takes moments for people to clap along to the beat of the song. Specific genres and styles of music have defined generations and cultures time and time again. It’s only natural for music to be so powerful for people.

This notion has picked up much attention in the media. In fact, ABC Science released a video a few years ago ( [watch it here](https://www.youtube.com/watch?v=rnUSNbqtVJI) ). discussing the power of music on the brain, specifically for people with dementia and Parkinson’s. In the video, researchers showed how playing music reminiscent of one’s past can trigger memories, even for someone who has forgotten them. They did so by curating specially tailored playlists from the pasts of certain residents at a nursing home. When the dementia patients listened to these playlists, many of them had a sudden shift in mood. Their family members were so surprised to see them “come back to life,” in a sense. These residents would talk about their past and be more open and happy than they had been in months.

Another segment of the video showed how music can help with diseases that affect the motor system, like Parkinson’s. At a human movement lab, a professor has spent years analyzing and trying to solve these movement disorders. One thing she tried was playing music, and it’s incredible to see the change that overcomes her patients. John, one of her patients, suffers from Parkinson’s. The video shows how the debilitating disease limits his natural motor skills and prevents him from having voluntary movements. However, after applying a nice tune with the professor’s music, John is able to not only walk, but dance with a partner.

The last part of the video follows a man named Shane who suffered severe brain damage from a bike accident. Following the accident, he could barely speak, move, and recall anything. Later, he became part of an experiment to see if music could invoke memories for people who had severe memory loss from brain injuries. The results showed that he did as well as people with normal, healthy brains, despite the accident. For example, Shane had trouble recalling a memory from grade school if he was just asked to, but had no issues doing so if a song from grade school was being played.

This video illustrates not only the power in music, but its prevalence in our natural being. It is much more than a form of entertainment, it is part of a complete life. The rhythm and tunes of songs -- whether from traditional instruments, natural sounds, or digital playlists -- bury themselves in our brains and become an integral part of human life. 

Additionally, music is not immune to the various societal trends that can morph and change over time. Since it is a form of art, it generally reflects on what major feelings and emotions are being spread in a given time. The prevalence of music in our lives combined with the artistic essence makes it a strong vantage point when looking at how society changes the way it expresses itself. For example, there are times in the late 1940’s and 1950’s where songs tend to be filled with sad or melancholic lyrics, making for more of a “low-mood” song. This has much to do with the major wars at the time, namely World War II and the subsequent Cold War. 

Other trends in music, and art in general, can illuminate these trends. Seeing the trends in how artists express their views of the world provides a look into life at during a given time period. Furthermore, the advantageous point with music is also that the popularity of a song or genre can be tracked. Music therefore not only gives a perspective on what songs and emotions are being produced in a given time, but to what extent each is consumed. So, it is possible to look at both the expressed emotions in music, and how much it resonates with listeners.

Change in music is not limited to different life periods, but is also present in different phases in one’s life. For example, there is a popular practice for pregnant mothers to play classical music for their babies in hopes of making them more intelligent. In other phases of life, teens may be warned to stay away from certain genres of music because it will “rot their brains” or act as a bad influence. In either case, music enters our lives early. Many young musical prodigies are discovered because they begin reacting to music even before they are able to speak or walk.

Our plan for this study relies on a comprehensive data set supplied by the [Spotify API](https://developer.spotify.com/documentation/web-api/reference-beta/#endpoint-get-audio-features). This data encompasses many interesting variables, and there is much to experiment with. It provides a fertile ground for exploration into how music affects humans. Two variables specifically are eye-catching: valence, a measure of the happiness of a song, and explicitness, whether a song contains explicit lyrics or not. There are also variables regarding year published, popularity, acousticness, etc. There is a perceived trend that current music (2010-2020) is becoming more and more explicit and despairing. In fact, this can be seen in Figure \@ref(fig:scattervalyear) with a dip in valence after 1975. It may be possible to look at these different characteristics in acousticness, valence, and explicitness to create a model that predicts the popularity of music. 


```{r scattervalyear,fig.width=5,fig.height=3,fig.cap="Scatterplot of Spotify's valence score by year"}

ggplot(data = spotify_by_year) +
  geom_point(mapping = aes(x = year, y = valence)) +
  labs(title = "Happiness of Music Over Time",
       x = "Year",
       y = "Valence (0 to 1)",
       caption = "Source: Spotify") +
  theme_proj 
```


In addition to a study of trends in music consumption, this study aims to take a closer look at correlations between the music dataset and other datasets in mental health and crime. Is it possible that the prevalence in explicit music is rising with crime rates? Is it possible that the decrease in valence score is correlated with an increase in mental health cases? These questions will be discussed in the subsequent sections.

# Data

The datasets used in this project required lots of work to clean and prepare for visualization and analysis. The data cleaning and code is outlines in the [ATABAS_HUANG_dataCleaning.Rmd file](https://github.com/tatabas/Stat41_finalproject), with short descriptions attached for each cleaning procedure.

**Music:**
The music dataset is made available through the [Spotify API](https://developer.spotify.com/documentation/web-api/reference-beta/#endpoint-get-audio-features). Spotify is an audio streaming service that was launched in 2008 and is now one of the most popular streaming platforms for music and podcasts. Therefore, the dataset is fairly comprehensive and contains lots of  information due to Spotify’s status as one of the most popular sites for music consumption. 

The data encompasses many interesting variables. Of course there are descriptors such as artist or band name, year of song, genre, and key, but there are many other metrics that require more attention.

These specially catered metrics usually range from 0 to 1. For example Spotify describes the metric for the valence (happiness) of a song as follows: “A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry)”.

Other metrics such as explicitness are described as follows: “Whether or not the episode has explicit content (true = yes it does; false = no it does not OR unknown)”. Whereas danceability is described as: “Danceability describes how suitable a track is for dancing based on a combination of musical elements including tempo, rhythm stability, beat strength, and overall regularity. A value of 0.0 is least danceable and 1.0 is most danceable”. 

**Crime:**

The United Nations Office on Drugs and Crime (UNODC) has many comprehensive datasets that pertain to crime of all different shapes and forms. The organization, as a subset of the United Nations, works to cover pressing concerns related to crime in general, but they focus on tackling and/or preventing crime. The datasets present on their website are grouped by type of crime with subsets for more details. For example, there are differentiations made between sexual violence, homicide, and assault. Further, assault can be analyzed more specifically through the different mechanisms (firearm, sharp object, serious, etc.)

With a dataset of this comprehensive nature, it is possible to make different comparisons by extracting the parts of the data that are of interest. In this case, it was of interest to study the relationship between trends in crime and trends in explicit music. There are many studies that have shown types of music to have a postivie impact (classical music, joyous music). However, there are also claims that media in the form of video games, TV, or music can have an equally negative impact depending on their contents. Along these lines, it may be interesting to explore any relationships between explicit music and crime.

The limitations to this dataset originate more from the collection process. The data are collected from the annual United Nations crime trends survey. This is conducted by the UNODC and takes responses from the government officials in a given country. This method not only relies on countries reporting to the U.N., but also relies on local authorities within countries like the U.S. and their reports to the federal level. There may be differences in reporting crime when compared to different countries, because each country can have different laws regarding different crimes. Even states or counties within a given country can have different guidelines for recording a crime. This should be kept in consideration when drawing conclusions.

Since all of these datasets were provided in separate files, it was necessary to read the excel files separately and then follow with a merge by year.

The data also comes in a format that is not easy to work with, having a column of rate and count for each year (i.e. rate of crime, count of crime). The years available are from 2010 to 2017.

The data from UNODC will be used to study

+ Assault 
+ Robbery
+ Sexual Violence

**World Happiness:**

The first World Happiness Report was released on April 1, 2012 as a foundational text for the UN High Level Meeting: Well-being and Happiness: Defining a New Economic Paradigm, drawing international attention. The report outlined the state of world happiness, causes of happiness and misery, and policy implications highlighted by case studies. In 2013, the second World Happiness Report was issued, and since then has been issued on an annual basis with the exception of 2014. The report primarily uses data from the Gallup World Poll.

The rankings of national happiness are based on a Cantril ladder survey. Nationally representative samples of respondents are asked to think of a ladder, with the best possible life for them being a 10, and the worst possible life being a 0. They are then asked to rate their own current lives on that 0 to 10 scale. The report correlates the results with various life factors.

In the reports, experts in fields including economics, psychology, survey analysis, and national statistics, describe how measurements of well-being can be used effectively to assess the progress of nations, and other topics. Each report is organized by chapters that delve deeper into issues relating to happiness, including mental illness, the objective benefits of happiness, the importance of ethics, policy implications, and links with the Organization for Economic Co-operation and Development's (OECD) approach to measuring subjective well-being and other international and national efforts.

Data is collected from people in over 150 countries. Each variable measured reveals a populated-weighted average score on a scale running from 0 to 10 that is tracked over time and compared against other countries. These variables currently include:

+ real GDP per capita
+ social support
+ healthy life expectancy
+ freedom to make life choices
+ generosity
+ perceptions of corruption

Each country is also compared against a hypothetical nation called Dystopia. Dystopia represents the lowest national averages for each key variable and is, along with residual error, used as a regression benchmark. The six metrics are used to explain the estimated extent to which each of these factors contribute to increasing life satisfaction when compared to the hypothetical nation of Dystopia, but they themselves do not have an impact on the total score reported for each country

In the above code, I have changed the variable names in each dataset so they should all (mostly) match with each other. Then, I combined all the datasets into one big "happiness" dataset.

# Exploration

## Spotify

There are some natural thoughts that may come up when thinking about what two characteristics in music may support each other, or on the other hand, go against each other. For example, one may think that acousticness and energy of a song are not necessarily compatible traits, however danceability and loudness may hold promise in a positive correlation. The pairs plot in Figure \@ref(fig:gally) explores these relationships and correlations.

```{r gally, fig.width=8,fig.height=8,fig.cap="Pairs plot for the variables in the Spotify dataset"}
library(GGally)

spotify_by_year %>%
  select(valence, acousticness, danceability, duration_ms, energy, instrumentalness, liveness, loudness, popularity, speechiness) %>%
  GGally::ggpairs() +
  theme_proj +
  #theme(panel.grid.major = element_blank(),
  #      panel.grid.minor = element_blank()) +
  labs(caption = "Source: Spotify", title = "Pairs plot for music")
```


By looking at the pairs plot, it is possible to see that acousticness and energy are inversely related, and pretty strong at that (refer to plot with \@ref(fig:gally), r = -0.967***). There are many other relationships to explore later when building a model. However, another promising relationships is between the loudness and popularity parameters. The songs that are louder also have a tendancy to be more popular.

```{r shiny-ggally}
library(shiny)

ui <- fluidPage(
    
    # Application title
    titlePanel("Looking at Music Trends (make a selection)"),
    
    # Sidebar layout with a input and output definitions
    sidebarLayout(
        # Inputs: Select variables to plot
        sidebarPanel(
            
            # Select variable for location
            selectInput(inputId = "x", 
                        label = "X Axis: ",
                        choices = c("Valence" = "valence", "Acousticness" = "acousticness",
                                    "Danceability" = "danceability", "Duration" = "duration_ms", 
                                    "Energy" = "energy", "Instrumentalness" = "instrumentalness",
                                    "Liveness" = "liveness", "Loudness" = "loudness", 
                                    "Popularity" = "popularity", "Speechiness" = "speechiness"),
                        selected = "acousticness",
                        multiple = FALSE),
            
            selectInput(inputId = "y",
                        label = "Y Axis: ",
                        choices = c("Valence" = "valence", "Acousticness" = "acousticness",
                                    "Danceability" = "danceability", "Duration" = "duration_ms", 
                                    "Energy" = "energy", "Instrumentalness" = "instrumentalness",
                                    "Liveness" = "liveness", "Loudness" = "loudness", 
                                    "Popularity" = "popularity", "Speechiness" = "speechiness"),
                        selected = "energy",
                        multiple = FALSE),
            
            checkboxInput(inputId = "mod",
                          label = "Line",
                          value = TRUE)
        ),
        
        #Output
        
        mainPanel(
            
            # Show plot
            plotlyOutput(outputId = "plot"),
            br(),        # a little bit of visual separation
            
        )
    )
)

# Define server function --------------------------------------------
server <- function(input, output) {
    
    output$plot <- renderPlotly({
   p3 <- 
     spotify_by_year %>%
     mutate(
       constant = 0.02
     ) %>%
     ggplot(aes_string(x = input$x, y = input$y)) +
     geom_point(aes(text = paste("Year:",year))) +
     theme_proj +
          #need to add gridlines because tufte removes them
          theme(panel.grid.major = element_line(color = "gray90"),
                panel.grid.minor = element_line(color = "gray90"),
                legend.position = "none") +
          labs(x = input$x, y = input$y,
               caption = "Source: Spotify") +
       if(input$mod) {geom_smooth(method = "lm", se = FALSE)}
   
   
    ggplotly(p3, tooltip = "text")
    })
}

# Create the Shiny app object ---------------------------------------
shinyApp(ui, server, options = list(height = 500))
```

## Happiness

Before we begin combining the Spotify dataset with other datasets, it's important to look at those datasets individually. For example, how does the World Happiness dataset change over each year?

```{r plotlyhappiness, fig.cap="Map of World Happiness from 2015 - 2020"}
#loading dataset of each country's ISO code (because plotly needs it to map countries)
# source: https://www.kaggle.com/andradaolteanu/iso-country-codes-global
country_code <- read_csv("data/wikipedia-iso-country-codes.csv")

#joining together happiness and country_code dataset
happiness_plotly <- left_join(country_code, happiness, by = c("English short name lower case" = "Country"))

#renaming the happiness dataset variables
colnames(happiness_plotly) = c("Country", "two.code", "three.code", "Numeric.code", "ISO",
                        "X", "Region", "Happiness.Rank", "Happiness.Score", "Standard.Error",
                        "Economy..GDP.per.Capita.", "Family", "Health..Life.Expectancy.",
                        "Freedom", "Trust..Government.Corruption.", "Generosity",
                        "Dystopia.Residual", "year", "mean", "Lower.Confidence.Interval",
                        "Upper.Confidence.Interval", "Logged.GDP.per.capita",
                        "Healthy.life.expectancy", "Ladder.score.in.Dystopia",
                        "Explained.by..Log.GDP.per.capita", "Explained.by..Social.support",
                        "Explained.by..Healthy.life.expectancy",
                        "Explained.by..Freedom.to.make.life.choices",
                        "Explained.by..Generosity",
                        "Explained.by..Perceptions.of.corruption")

#"hover" variable: this specifies what info is displayed when you hover over a country
happiness_plotly <- happiness_plotly %>% mutate(hover = paste0(Country, "\nHappiness Rank: ", Happiness.Rank, "\nHappiness Score: ", Happiness.Score))

#hover label aesthetics
fontStyle <- list(family = "Arial", size = 15, color = "black")
label <- list(bgcolor = "#EEEEEE", bordercolor = "transparent", font = fontStyle)

#plotly map!
p1 <- plot_geo(happiness_plotly, locationmode = "world", frame = ~year) %>%
  add_trace(locations = ~three.code,
            z = ~Happiness.Score,
            zmin = 2,
            zmax = 8,
            color = ~Happiness.Score,
            colorscale = "Electric", #changes color of scale
            text = ~hover, #displays info in "hover" variable we made above
            hoverinfo = "text") %>% #makes hover info the text from above line
  layout(font = list(family = "Arial"), title = "World Happiness Report \n 2015 - 2020") %>%
  style(hoverlabel = label) %>%
  config(displayModeBar = FALSE) #hides the plotly toolbar in top right

p1
# credit to this tutorial: https://www.youtube.com/watch?v=RrtqBYLf404
```

The world map above, in Figure \@ref(fig:plotlyhappiness), is an interactive map that displays the change in world happiness in countries over the years from $2015$ to $2020$. (Hover over countries to see more specific information.)

```{r happiness-ridges, fig.cap = "Density Ridges Plot of Happiness by Region"}
library(ggridges)
ggplot(happiness, aes(y = Region, x = Happiness.Score, fill = Region)) + 
  geom_density_ridges(alpha = .8) +
  scale_fill_viridis_d(end = .75, option = "B") + 
  scale_color_viridis_d(end = .75, option = "B") + 
  theme_proj +
  theme(legend.position = "none") +
  labs(title = "Happiness Score of Each Region",
       x = "Happiness Score",
       y = "Region",
       caption = "Source: World Happiness Report")
```

```{r happy-ridges}
happiness_2015 <- rbind(happiness_2015, happiness_2015[rep(5, 1), ])
happiness_2015 <- rbind(happiness_2015, happiness_2015[rep(15, 1), ])
happiness_2015 <- rbind(happiness_2015, happiness_2015[rep(9, 1), ])
happiness_2015 <- rbind(happiness_2015, happiness_2015[rep(10, 1), ])
happiness_2016 <- rbind(happiness_2016, happiness_2016[rep(6, 1), ])
happiness_2016 <- rbind(happiness_2016, happiness_2016[rep(13, 1), ])
happiness_2016 <- rbind(happiness_2016, happiness_2016[rep(8, 1), ])
happiness_2016 <- rbind(happiness_2016, happiness_2016[rep(9, 1), ])
  
plot0 <- ggplot(happiness_2015, aes(y = Region, x = Happiness.Score, fill = Region)) + 
  geom_density_ridges(alpha = .8) +
  scale_fill_viridis_d(end = .75, option = "B") + 
  scale_color_viridis_d(end = .75, option = "B") + 
  theme_proj +
  theme(legend.position = "none",
        plot.subtitle = element_text(hjust = 1)) +
  labs(title = "Happiness Score of Each Region",
       subtitle = "2015",
       y = "Region",
       x = element_blank())

plot1 <- ggplot(happiness_2016, aes(y = Region, x = Happiness.Score, fill = Region)) +
  geom_density_ridges(alpha = .8) +
  scale_fill_viridis_d(end = .75, option = "B") +
  scale_color_viridis_d(end = .75, option = "B") +
  theme_proj +
  theme(legend.position = "none",
        axis.text.y = element_blank(),
        plot.subtitle = element_text(hjust = 1)) +
  labs(subtitle = "2016",
       y = element_blank(), 
       x ="Happiness Score")

plot2 <- ggplot(happiness_2020, aes(y = Regional.indicator, x = Ladder.score, fill = Regional.indicator)) +
  geom_density_ridges(alpha = .8) +
  scale_fill_viridis_d(end = .75, option = "B") +
  scale_color_viridis_d(end = .75, option = "B") +
  theme_proj +
  theme(legend.position = "none",
        plot.subtitle = element_text(hjust = 1))+
  labs(subtitle = "2020",
       caption = "SOURCE: World Happiness Report",
       y = element_blank(), 
       x = element_blank())

plot0 + plot1 + plot2
```

The plot above shows a density plot of the happiness scores across different regions of the world. Note that some countries are included twice (ex: in Southeastern Asia AND in South Asia), as well as the fact that $2017$, $2018$, and $2019$ do not split countries into regions, so the happiness score is not plotted for those years. The most noticeable trends are that Western Europe, North America, and Australia and New Zealand tend to have the highest happiness scores.

```{r happiness-over-time, fig.cap="World Happiness from 2015 - 2020"}
ggplot(data = happiness) +
  geom_point(mapping = aes(x = year, y = mean)) +
  geom_line(mapping = aes(x = year, y = mean)) +
  labs(title = "World Happiness Score Over Time",
       subtitle = "average of every country's score each year",
       x = "",
       y = "Happiness Score",
       caption = "Source: World Happiness Report") +
  theme_proj +
  theme(panel.grid.major = element_line(color = "gray90"),
        panel.grid.minor = element_line(color = "gray90"))
```

Figure \@ref(fig:happiness-over-time) shows the mean happiness of the world over time. The range is typically from $0$ to $10$, where $10$ would be the happiest, so it's important to note that while there is an increase in happiness after $2017$, the average only goes up by about $0.125$ points.

## Crime

Continuing with the exploration, it is time to look at the crime data. The crime data comes from the United Nations Office on Drugs and Crime and depends on reportings from each country. This can create a discrepancy because each country has different considerations and guidelines on crime which will dictate if a specific incident enters their records or not.

Withstanding these limitations, it is still beneficial to look at what is made available at hand. The shiny app allows the viewing of country assault rates, filtered by regions.

```{r shiny}
library(shiny)

regions = assault$Region

ui <- fluidPage(
    
    # Application title
    titlePanel("Looking at Rate by Region (make a selection)"),
    
    # Sidebar layout with a input and output definitions
    sidebarLayout(
        # Inputs: Select variables to plot
        sidebarPanel(
            
            selectInput(inputId = "crime",
                        label = "Type of Crime: ",
                        choices = c("Assault" = "assault", 
                                    "Robbery" = "robbery", "Sexual Violence" = "sexualviolence"),
                        selected = "assault",
                        multiple = FALSE),
          
            # Select variable for location
            selectInput(inputId = "reg", 
                        label = "Region:",
                        choices = regions, 
                        selected = "Africa",
                        multiple = FALSE),
            
            uiOutput("sub")
        ),
        
        #Output
        
        mainPanel(
            
            # Show plot
            plotlyOutput(outputId = "plot"),
            br(),        # a little bit of visual separation
            
        )
    )
)

# Define server function --------------------------------------------
server <- function(input, output) {
  
    type <- reactive({
      req(input$crime)
      if(input$crime == "assault"){assault}
      else if (input$crime == "robbery"){robbery}
      else {sexualviolence} 
    })
    
    #output$sub <- renderUI({
        #req(input$reg)
        #this_region <- type
        
        #sub_this_location <- sort(unique(this_region$Subregion))
        
        #selectInput(inputId = "sub", label = "Sub Region:", choices = sub_this_location, 
                    #selected = "Middle Africa", multiple = FALSE)
    #})
    
    output$sub <- renderUI({
        req(input$reg)
        this_region <- if(input$crime == "assault"){assault %>% filter(Region == input$reg)}
                        else if (input$crime == "robbery"){robbery %>% filter(Region == input$reg)}
                        else {sexualviolence %>% filter(Region == input$reg)} 
        
        sub_this_location <- sort(unique(this_region$Subregion))
        
        selectInput(inputId = "sub", label = "Sub Region:", choices = sub_this_location, 
                    selected = "Middle Africa", multiple = FALSE)
    })
    
    # Creates plot object the plotOutput function is expecting
    output$plot <- renderPlotly({
        
        #Creates base plot 
        
        Region_of_Interest = input$reg
        Sub_of_Interest = input$sub
        
        plot_data <- type() %>% 
            filter(Region == Region_of_Interest) %>%
            filter(Subregion == Sub_of_Interest) 
            
            p3 <- ggplot(data = plot_data,aes(x = Year, y = as.numeric(Rate), 
                          color = Country)) + 
              geom_line(aes(text = Country)) +
              geom_point(aes(text = Country), 
                      size = 3, alpha = 0.8) +
          theme_proj +
          #need to add gridlines because tufte removes them
          theme(panel.grid.major = element_line(color = "gray90"),
                panel.grid.minor = element_line(color = "gray90"),
                legend.position = "none") +
          labs(x = "Year", y = "Assault rate (per 100,000 population)",
               caption = "Source: UNOCD Serious Assault Crime Data")
          
            
        
        ggplotly(p3, tooltip = "text")
    })
    
    
}

# Create the Shiny app object ---------------------------------------
shinyApp(ui, server, options = list(height = 500))
```

The shiny app makes it possible to see trends in countries of certain regions and how they compare to each other. For example, it is clear that Hungary and Czech Republic have the highest rates of assault in the Eastern European regions. This type of observation can be made with a few other countries as well. Each region has a separate country that stands out.

Also, the lines through the points show that not all countries have data for every year. This can be a limitation, however, the methods used later will make use of the general trends and not data per country.

Even more, however, it is possible to see that there have not been many changes in rates over time. For example, the average rates as shown in Figure \@ref(fig:robbery) shows that the rates have not changed greatly over the years.

Robbery below... (still needs work)

```{r robbery, fig.width = 9, fig.height= 3, fig.cap = "Rates of Crime by Year and Region"}
p1 <- assault %>%
  group_by(Year, Region) %>%
  summarise(
    means = mean(as.numeric(Rate), na.rm = TRUE)
  ) %>%
  ggplot() +
    geom_col(aes(x = Year, y = means, fill = means)) +
  theme_proj +
  scale_fill_viridis_c(option = "B", direction = -1) +
  guides(fill = FALSE) +
  labs(x = "Year", y = "Mean Rate per 100,000 population",
       title = "Mean Rate of Assault per 100,000 population by Year",
       caption = "Source: UNODC Serious Assault Crime Data") +
  theme(plot.title = element_text(size = 8)) +
  theme(axis.text.x = element_text(angle = 45, vjust = .1, hjust=.1)) +
  facet_grid(. ~ Region)

p2 <- robbery %>%
  group_by(Year, Region) %>%
  summarise(
    means = mean(as.numeric(Rate), na.rm = TRUE)
  ) %>%
  ggplot() +
    geom_col(aes(x = Year, y = means, fill = means)) +
  theme_proj +
  scale_fill_viridis_c(option = "B", direction = -1) +
  guides(fill = FALSE) +
  labs(x = "Year", y = element_blank(),
       title = "Mean Rate of Robbery per 100,000 population by Year",
       caption = "Source: UNODC Robbery Crime Data") +
  theme(plot.title = element_text(size = 8)) +
  theme(axis.text.x = element_text(angle = 45, vjust = .1, hjust=.1)) +
  facet_grid(. ~ Region)

p3 <- sexualviolence %>%
  group_by(Year, Region) %>%
  summarise(
    means = mean(as.numeric(Rate), na.rm = TRUE)
  ) %>%
  ggplot() +
    geom_col(aes(x = Year, y = means, fill = means)) +
  theme_proj +
  scale_fill_viridis_c(option = "B", direction = -1) +
  guides(fill = FALSE) +
  labs(x = "Year", y = element_blank(),
       title = "Mean Rate of Sexual Violence per 100,000 population by Year",
       caption = "Source: UNODC Sexual Violence Crime Data") +
  theme(plot.title = element_text(size = 8), 
        axis.text.x = element_text(angle = 45, vjust = .1, hjust=.1)) +
  facet_grid(. ~ Region)

p1 + p2 + p3
```

# Comparing Datasets/Variables

## Valence and Happiness

```{r valence-2015-2020}
spotify_by_year_small <- spotify_by_year %>% filter(year == 2015 | year == 2016 | year == 2017 | year == 2018 | year == 2019 | year == 2020)

ggplot(data = spotify_by_year_small) +
  geom_point(mapping = aes(x = year, y = valence)) +
  geom_line(mapping = aes(x = year, y = valence)) +
  labs(title = "Happiness of Music Over Time",
       x = "Year",
       y = "Valence (0 to 1)",
       caption = "SOURCE: Spotify") +
  theme_proj +
  theme(panel.grid.major = element_line(color = "gray90"),
        panel.grid.minor = element_line(color = "gray90"))
```

(This is the same EDA graph from earlier, but we limited the years to just $2015$ to $2020$ because these are the only years available in our World Happiness dataset.)

```{r happiness-valence-lm}
spotify_and_happiness <- left_join(spotify_by_year_small, happiness, by = c("year" = "year"))
ggplot(data = spotify_and_happiness) +
  geom_point(mapping = aes(x = valence, y = mean)) +
  #geom_smooth(mapping = aes(x = valence, y = mean), method = "lm", se = FALSE) +
  theme_proj +
  labs(title = "Relationship between Yearly Mean Valence and Mean World Happiness",
       x = "yearly mean valence",
       y = "mean happiness score",
       caption = "SOURCE: World Happiness Report and Spotify")
```

In Figure \@ref(fig:happiness-valence-lm), the music and happiness datasets were combined. In doing so, this means that each country now has one valence value, and one (mean) happiness score. There does appear to be a trend here: as the valence score increases, the mean happiness score also increases. However, this is a slightly inaccurate representation of, at the very least, happiness score because each country has different happiness scores.

```{r happy-cor}
plot00 <- ggplot(data = spotify_and_happiness, aes(x = as.factor(round(valence,4)), y = Happiness.Score)) +
  geom_jitter(mapping = aes(text = paste("Country: ",
                                         Country,"\n Happiness Score: ",
                                         Happiness.Score, "\n Year: ", year)), alpha = 0.5) +
  geom_boxplot(alpha= 0.5, aes(fill = year)) +
  scale_fill_viridis_c(option = "B") +
  guides(fill = FALSE) +
  labs(x = "Yearly Average Valence", y = "Happiness Score",
       title = "Yearly Average Valence and World Happiness Scores") +
  theme_proj

ggplotly(plot00, tooltip = "text")
```

In Figure \@ref(fig:happy-cor), each individual country's happiness score was plotted against a valence value with boxplots overlayed on top. The plot is interactive to display the country name, happiness score, and year of each point. USince the music dataset does not have a country variable, each year/country is still only associated with one valence value. Therefore, valence was treated as a categorical variable in the above plot in order to overlay the boxplots on top of the points, so the distance between the valence values are not proportionate. Though changes in the plot are very minute, it's visible to see in the last four boxplots that the median happiness score, as well as the 75th quantile, increases as the valence increases.

## Crime and Explicitness

```{r regress-assault, fig.cap="Comparing rate of crime (for 100,000 population) and percent explicit music per year for 2010-2017, displayed by region for each type of crime: assault, robbery, and sexual violence"}
all_together %>%
  ggplot(aes(x = Rate, y = perc_expl, color = year)) +
    geom_jitter(size = 0.3, alpha = 0.6) +
    geom_smooth(
    method = "glm", method.args = list(family = "binomial"), 
    color = "#2E2927", se = FALSE, size = 1
    ) +
    scale_color_viridis_c(option = "B", direction = -1) +
    #scale_color_distiller(palette = "YlOrRd", direction = 1) +
    facet_grid(type ~ ., scale = "free_x") +
    labs(x = "Log Rate of Crime", y = "% Explicit Music", 
         color = "Year", caption = "Source: UNODC Crime Data and Spotify API",
         title = "Crime Rates and Explicit Music") +
    scale_x_log10() +
    theme_proj
```

# Conclusions & Discussions

```{r}
glimpse(sample_n(spotify, 5))
```

The main purpose of the conclusion will also be to re-evaluate the comparisons while drawing from the EDA to guide a discussion.

Music is a form of expression, and it tends to reflect societal feelings and